<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro - Smart Show</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üì± Smart Show</h1>
            <div class="user-info">
                <span id="userName">Usu√°rio</span>
                <button id="logoutBtn" class="btn btn-secondary">Sair</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <a href="index.html" class="nav-item">Dashboard</a>
            <a href="caixa.html" class="nav-item">Caixa</a>
            <a href="produtos.html" class="nav-item">Produtos</a>
            <a href="clientes.html" class="nav-item">Clientes</a>
            <a href="assistencia.html" class="nav-item">Assist√™ncia</a>
            <a href="financeiro.html" class="nav-item active">Financeiro</a>
            <a href="relatorios.html" class="nav-item">Relat√≥rios</a>
            <a href="configuracao.html" class="nav-item" id="configNavItem" style="display: none;">Configura√ß√£o</a>
        </nav>

        <!-- Main Content -->
        <main class="main">
            <h2>Financeiro</h2>

            <!-- Cards de Resumo -->
            <div class="dashboard-grid" style="margin-bottom: 2rem;">
                <div class="card">
                    <h3>Contas a Receber</h3>
                    <div class="card-value" id="totalReceivable">R$ 0,00</div>
                    <div class="card-count" id="receivableCount">0 contas</div>
                </div>
                <div class="card">
                    <h3>Contas a Pagar</h3>
                    <div class="card-value" id="totalPayable">R$ 0,00</div>
                    <div class="card-count" id="payableCount">0 contas</div>
                </div>
            </div>

            <!-- Abas -->
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-secondary" onclick="showTab('receivable')">Contas a Receber</button>
                <button class="btn btn-secondary" onclick="showTab('payable')">Contas a Pagar</button>
            </div>

            <!-- Tabela de Contas a Receber -->
            <div id="receivableTab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Contas a Receber</h3>
                    <button class="btn btn-primary" onclick="addReceivable()">+ Nova Conta</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Descri√ß√£o</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Vencimento</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="receivableTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tabela de Contas a Pagar -->
            <div id="payableTab" class="tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Contas a Pagar</h3>
                    <button class="btn btn-primary" onclick="addPayable()">+ Nova Conta</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Descri√ß√£o</th>
                                <th>Fornecedor</th>
                                <th>Valor</th>
                                <th>Vencimento</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="payableTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/access-control.js"></script>
    <script>
        function showTab(tab) {
            document.getElementById('receivableTab').style.display = tab === 'receivable' ? 'block' : 'none';
            document.getElementById('payableTab').style.display = tab === 'payable' ? 'block' : 'none';
        }

        let customers = [];
        let currentTab = 'receivable';

        // Helper para obter headers com token
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }

        // Carregar clientes
        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers', {
                    headers: getAuthHeaders()
                });
                customers = await response.json();
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Carregar contas a receber
        async function loadReceivable() {
            try {
                const response = await fetch('/api/financial/receivable', {
                    headers: getAuthHeaders()
                });
                const accounts = await response.json();
                const tbody = document.getElementById('receivableTableBody');
                
                if (accounts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">Nenhuma conta encontrada</td></tr>';
                    return;
                }

                tbody.innerHTML = accounts.map(account => `
                    <tr>
                        <td>${account.description || '-'}</td>
                        <td>${account.customer_name || '-'}</td>
                        <td>R$ ${parseFloat(account.amount || 0).toFixed(2).replace('.', ',')}</td>
                        <td>${new Date(account.due_date).toLocaleDateString('pt-BR')}</td>
                        <td><span class="badge ${account.status === 'paid' ? 'badge-success' : account.status === 'overdue' ? 'badge-danger' : 'badge-warning'}">${account.status === 'paid' ? 'Paga' : account.status === 'overdue' ? 'Vencida' : 'Pendente'}</span></td>
                        <td>
                            ${account.status !== 'paid' ? `<button class="btn btn-sm btn-success" onclick="payAccount(${account.id}, 'receivable')">Pagar</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar contas a receber:', error);
                document.getElementById('receivableTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: red;">Erro ao carregar dados</td></tr>';
            }
        }

        // Carregar contas a pagar
        async function loadPayable() {
            try {
                const response = await fetch('/api/financial/payable', {
                    headers: getAuthHeaders()
                });
                const accounts = await response.json();
                const tbody = document.getElementById('payableTableBody');
                
                if (accounts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">Nenhuma conta encontrada</td></tr>';
                    return;
                }

                tbody.innerHTML = accounts.map(account => `
                    <tr>
                        <td>${account.description || '-'}</td>
                        <td>${account.supplier_name || '-'}</td>
                        <td>R$ ${parseFloat(account.amount || 0).toFixed(2).replace('.', ',')}</td>
                        <td>${new Date(account.due_date).toLocaleDateString('pt-BR')}</td>
                        <td><span class="badge ${account.status === 'paid' ? 'badge-success' : account.status === 'overdue' ? 'badge-danger' : 'badge-warning'}">${account.status === 'paid' ? 'Paga' : account.status === 'overdue' ? 'Vencida' : 'Pendente'}</span></td>
                        <td>
                            ${account.status !== 'paid' ? `<button class="btn btn-sm btn-success" onclick="payAccount(${account.id}, 'payable')">Pagar</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar contas a pagar:', error);
                document.getElementById('payableTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: red;">Erro ao carregar dados</td></tr>';
            }
        }

        // Adicionar conta a receber
        function addReceivable() {
            currentTab = 'receivable';
            showAccountModal('receivable');
        }

        // Adicionar conta a pagar
        function addPayable() {
            currentTab = 'payable';
            showAccountModal('payable');
        }

        // Mostrar modal de conta
        function showAccountModal(type) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Nova Conta ${type === 'receivable' ? 'a Receber' : 'a Pagar'}</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <form id="accountForm" onsubmit="saveAccount(event, '${type}')">
                        ${type === 'receivable' ? `
                            <div class="form-group">
                                <label>Cliente *</label>
                                <select id="customerId" class="form-control" required>
                                    <option value="">Selecione um cliente</option>
                                    ${customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                </select>
                            </div>
                        ` : `
                            <div class="form-group">
                                <label>Fornecedor</label>
                                <input type="text" id="supplierName" class="form-control" placeholder="Nome do fornecedor">
                            </div>
                        `}
                        <div class="form-group">
                            <label>Descri√ß√£o ${type === 'payable' ? '*' : ''}</label>
                            <input type="text" id="description" class="form-control" ${type === 'payable' ? 'required' : ''} placeholder="Descri√ß√£o da conta">
                        </div>
                        <div class="form-group">
                            <label>Valor *</label>
                            <input type="number" id="amount" class="form-control" step="0.01" min="0.01" required placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label>Data de Vencimento *</label>
                            <input type="date" id="dueDate" class="form-control" required>
                        </div>
                        <div style="text-align: right; margin-top: 1rem;">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Definir data padr√£o (hoje + 30 dias)
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30);
            document.getElementById('dueDate').value = defaultDate.toISOString().split('T')[0];
        }

        // Salvar conta
        async function saveAccount(event, type) {
            event.preventDefault();
            
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const dueDate = document.getElementById('dueDate').value;

            try {
                const url = type === 'receivable' ? '/api/financial/receivable' : '/api/financial/payable';
                const body = type === 'receivable' 
                    ? {
                        customerId: parseInt(document.getElementById('customerId').value),
                        description: description,
                        amount: amount,
                        dueDate: dueDate
                    }
                    : {
                        description: description,
                        amount: amount,
                        dueDate: dueDate,
                        supplierId: null
                    };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erro ao salvar conta');
                }

                // Fechar modal e recarregar dados
                event.target.closest('.modal').remove();
                await loadFinancialData();
                alert('Conta salva com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar conta:', error);
                alert('Erro ao salvar conta: ' + error.message);
            }
        }

        // Pagar conta
        async function payAccount(id, type) {
            const amount = prompt('Valor a pagar:');
            if (!amount || parseFloat(amount) <= 0) {
                return;
            }

            try {
                const response = await fetch(`/api/financial/pay/${id}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        paymentMethod: 'money',
                        paymentDate: new Date().toISOString().split('T')[0],
                        type: type
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erro ao pagar conta');
                }

                await loadFinancialData();
                alert('Conta paga com sucesso!');
            } catch (error) {
                console.error('Erro ao pagar conta:', error);
                alert('Erro ao pagar conta: ' + error.message);
            }
        }

        // Carregar todos os dados financeiros
        async function loadFinancialData() {
            try {
                const response = await fetch('/api/financial', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                // Atualizar totais
                document.getElementById('totalReceivable').textContent = 
                    `R$ ${parseFloat(data.totalReceivable || 0).toFixed(2).replace('.', ',')}`;
                document.getElementById('receivableCount').textContent = 
                    `${data.receivableCount || 0} contas`;
                document.getElementById('totalPayable').textContent = 
                    `R$ ${parseFloat(data.totalPayable || 0).toFixed(2).replace('.', ',')}`;
                document.getElementById('payableCount').textContent = 
                    `${data.payableCount || 0} contas`;

                // Carregar tabelas
                await loadReceivable();
                await loadPayable();
            } catch (error) {
                console.error('Erro ao carregar dados financeiros:', error);
            }
        }

        // Carregar dados financeiros
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCustomers();
            await loadFinancialData();
        });
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos - Smart Show</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Smart Show</h1>
            <div class="user-info">
                <span id="userName">Usu√°rio</span>
                <button id="logoutBtn" class="btn btn-secondary">Sair</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <a href="index.html" class="nav-item">Dashboard</a>
            <a href="caixa.html" class="nav-item">Caixa</a>
            <a href="produtos.html" class="nav-item active">Produtos</a>
            <a href="clientes.html" class="nav-item">Clientes</a>
            <a href="assistencia.html" class="nav-item">Assist√™ncia</a>
            <a href="financeiro.html" class="nav-item">Financeiro</a>
            <a href="relatorios.html" class="nav-item">Relat√≥rios</a>
            <a href="configuracao.html" class="nav-item" id="configNavItem" style="display: none;">Configura√ß√£o</a>
        </nav>

        <!-- Main Content -->
        <main class="main">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>Produtos</h2>
                <div style="display: flex; gap: 1rem;">
                    <button id="returnsBtn" class="btn btn-secondary">Devolu√ß√µes</button>
                    <button id="addProductBtn" class="btn btn-primary">+ Novo Produto</button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters" style="margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                <input type="text" id="searchProduct" class="form-control" placeholder="Buscar produto..." style="max-width: 300px;">
                <select id="filterCategory" class="form-control" style="max-width: 200px;">
                    <option value="">Todas as categorias</option>
                </select>
                <select id="filterSupplier" class="form-control" style="max-width: 200px;">
                    <option value="">Todos os fornecedores</option>
                </select>
            </div>

            <!-- Tabela de Produtos -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>C√≥digo de Barras</th>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Fornecedor</th>
                            <th>Estoque</th>
                            <th>Pre√ßo Custo</th>
                            <th>Pre√ßo Venda</th>
                            <th>Lucro</th>
                            <th>% Lucro</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 2rem;">
                                Carregando produtos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal de Produto -->
    <div id="productModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeProductModal()">&times;</span>
            <h2 id="productModalTitle">Novo Produto</h2>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName">Nome *</label>
                    <input type="text" id="productName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="productBarcode">C√≥digo de Barras</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="productBarcode" class="form-control" style="flex: 1;" placeholder="Escaneie com o leitor ou digite manualmente">
                        <button type="button" id="generateBarcodeBtn" class="btn btn-secondary" onclick="generateUniqueBarcode()" title="Gerar c√≥digo autom√°tico">
                            Gerar
                        </button>
                    </div>
                    <small style="color:#718096; display:block; margin-top:0.25rem;">
                        Dica: para reaproveitar etiquetas antigas, basta posicionar o cursor neste campo e usar o leitor de c√≥digo de barras.
                    </small>
                </div>
                <div class="form-group">
                    <label for="productDescription">Descri√ß√£o</label>
                    <textarea id="productDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="productCategory">Categoria</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="productCategory" class="form-control" style="flex: 1;">
                            <option value="">Selecione uma categoria</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="openQuickCategoryModal()" title="Adicionar nova categoria">
                            + Nova
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productSupplier">Fornecedor</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="productSupplier" class="form-control" style="flex: 1;">
                            <option value="">Selecione um fornecedor</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="openQuickSupplierModal()" title="Adicionar novo fornecedor">
                            + Novo
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productPrice">Pre√ßo de Venda *</label>
                    <input type="number" id="productPrice" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="productCost">Pre√ßo de Custo</label>
                    <input type="number" id="productCost" class="form-control" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="productStock">Estoque</label>
                    <input type="number" id="productStock" class="form-control" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="productMinStock">Estoque M√≠nimo</label>
                    <input type="number" id="productMinStock" class="form-control" min="0" value="0">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal R√°pido de Categoria -->
    <div id="quickCategoryModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeQuickCategoryModal()">&times;</span>
            <h2>Nova Categoria</h2>
            <form id="quickCategoryForm">
                <div class="form-group">
                    <label for="quickCategoryName">Nome da Categoria *</label>
                    <input type="text" id="quickCategoryName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="quickCategoryDescription">Descri√ß√£o</label>
                    <textarea id="quickCategoryDescription" class="form-control" rows="2"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeQuickCategoryModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal R√°pido de Fornecedor -->
    <div id="quickSupplierModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeQuickSupplierModal()">&times;</span>
            <h2>Novo Fornecedor</h2>
            <form id="quickSupplierForm">
                <div class="form-group">
                    <label for="quickSupplierName">Nome do Fornecedor *</label>
                    <input type="text" id="quickSupplierName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="quickSupplierCnpj">CNPJ</label>
                    <input type="text" id="quickSupplierCnpj" class="form-control" placeholder="00.000.000/0000-00">
                </div>
                <div class="form-group">
                    <label for="quickSupplierPhone">Telefone</label>
                    <input type="text" id="quickSupplierPhone" class="form-control" placeholder="(00) 00000-0000">
                </div>
                <div class="form-group">
                    <label for="quickSupplierEmail">Email</label>
                    <input type="email" id="quickSupplierEmail" class="form-control">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeQuickSupplierModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Devolu√ß√µes -->
    <div id="returnsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px;">
            <span class="close" onclick="closeReturnsModal()">&times;</span>
            <h2>Devolu√ß√µes de Produtos</h2>
            
            <!-- Bot√£o para nova devolu√ß√£o -->
            <div style="margin-bottom: 1rem;">
                <button id="addReturnBtn" class="btn btn-primary">+ Nova Devolu√ß√£o</button>
            </div>

            <!-- Tabela de devolu√ß√µes -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>N¬∫ Devolu√ß√£o</th>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Produto</th>
                            <th>Defeito</th>
                            <th>A√ß√£o</th>
                            <th>Valor Original</th>
                            <th>Forma Pagamento</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="returnsTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 2rem;">
                                Carregando devolu√ß√µes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Nova/Editar Devolu√ß√£o -->
    <div id="returnFormModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeReturnFormModal()">&times;</span>
            <h2 id="returnFormTitle">Nova Devolu√ß√£o</h2>
            <form id="returnForm">
                <input type="hidden" id="returnId">
                
                <div class="form-group">
                    <label for="returnSaleId">Buscar Venda *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="returnSaleSearch" class="form-control" placeholder="N√∫mero da venda ou c√≥digo de barras do produto" style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="searchSaleForReturn()">Buscar</button>
                    </div>
                    <small style="color: #718096;">Digite o n√∫mero da venda ou escaneie o c√≥digo de barras do produto</small>
                </div>

                <div id="saleInfoContainer" style="display: none; margin: 1rem 0; padding: 1rem; background: #f7fafc; border-radius: 4px;">
                    <h4>Informa√ß√µes da Venda</h4>
                    <div id="saleInfoContent"></div>
                    <input type="hidden" id="returnSaleId">
                    <input type="hidden" id="returnSaleItemId">
                    <input type="hidden" id="returnProductId">
                    <input type="hidden" id="returnCustomerId">
                    <input type="hidden" id="returnOriginalPrice">
                    <input type="hidden" id="returnOriginalPaymentMethod">
                </div>

                <div class="form-group">
                    <label for="returnDefectDescription">Defeito Relatado *</label>
                    <textarea id="returnDefectDescription" class="form-control" rows="3" required placeholder="Ex: Fone est√° chiando, tela quebrada, etc."></textarea>
                </div>

                <div class="form-group">
                    <label for="returnActionType">A√ß√£o a Realizar *</label>
                    <select id="returnActionType" class="form-control" required onchange="handleReturnActionTypeChange()">
                        <option value="">Selecione...</option>
                        <option value="same_product">Trocar pelo mesmo produto</option>
                        <option value="different_product">Trocar por outro produto</option>
                        <option value="refund">Devolver dinheiro</option>
                    </select>
                </div>

                <div id="replacementProductContainer" style="display: none;">
                    <div class="form-group">
                        <label for="returnReplacementProduct">Produto de Substitui√ß√£o *</label>
                        <select id="returnReplacementProduct" class="form-control">
                            <option value="">Selecione o produto...</option>
                        </select>
                        <div id="priceDifferenceInfo" style="margin-top: 0.5rem; padding: 0.5rem; background: #e6fffa; border-radius: 4px; display: none;">
                            <strong>Diferen√ßa de valor: </strong><span id="priceDifferenceValue"></span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="returnObservations">Observa√ß√µes</label>
                    <textarea id="returnObservations" class="form-control" rows="2" placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
                </div>

                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeReturnFormModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/access-control.js"></script>
    <script src="js/barcode-reader.js"></script>
    <script>
        let products = [];
        let allProducts = []; // Todos os produtos (sem filtro)
        let categories = [];
        let suppliers = [];
        let productBarcodeReader = null;

        // Carregar categorias
        async function loadCategories() {
            try {
                categories = await api.getCategories();
                
                const filterSelect = document.getElementById('filterCategory');
                const productSelect = document.getElementById('productCategory');
                
                // Limpar e preencher select de filtro
                while (filterSelect.options.length > 1) {
                    filterSelect.remove(1);
                }
                
                // Limpar e preencher select do formul√°rio
                while (productSelect.options.length > 1) {
                    productSelect.remove(1);
                }
                
                categories.forEach(category => {
                    // Adicionar ao filtro
                    const filterOption = document.createElement('option');
                    filterOption.value = category.id;
                    filterOption.textContent = category.name;
                    filterSelect.appendChild(filterOption);
                    
                    // Adicionar ao formul√°rio
                    const productOption = document.createElement('option');
                    productOption.value = category.id;
                    productOption.textContent = category.name;
                    productSelect.appendChild(productOption);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        // Carregar fornecedores
        async function loadSuppliers() {
            try {
                suppliers = await api.getSuppliers();
                
                const filterSelect = document.getElementById('filterSupplier');
                const productSelect = document.getElementById('productSupplier');
                
                // Limpar e preencher select de filtro
                while (filterSelect.options.length > 1) {
                    filterSelect.remove(1);
                }
                
                // Limpar e preencher select do formul√°rio
                while (productSelect.options.length > 1) {
                    productSelect.remove(1);
                }
                
                suppliers.forEach(supplier => {
                    // Adicionar ao filtro
                    const filterOption = document.createElement('option');
                    filterOption.value = supplier.id;
                    filterOption.textContent = supplier.name;
                    filterSelect.appendChild(filterOption);
                    
                    // Adicionar ao formul√°rio
                    const productOption = document.createElement('option');
                    productOption.value = supplier.id;
                    productOption.textContent = supplier.name;
                    productSelect.appendChild(productOption);
                });
            } catch (error) {
                console.error('Erro ao carregar fornecedores:', error);
            }
        }

        // Carregar produtos
        async function loadProducts(searchTerm = '', categoryId = '', supplierId = '') {
            try {
                console.log('üì• Carregando produtos...', { searchTerm, categoryId, supplierId });
                products = await api.getProducts(searchTerm, categoryId, supplierId);
                console.log('‚úÖ Produtos carregados:', products);
                
                // Salvar todos os produtos na primeira carga
                if (!searchTerm && !categoryId && !supplierId) {
                    allProducts = products;
                }
                
                renderProducts(products);
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                const tbody = document.getElementById('productsTableBody');
                const errorMsg = error.message || 'Erro desconhecido';
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 2rem; color: red;">Erro ao carregar produtos: ${errorMsg}</td></tr>`;
            }
        }

        // Renderizar produtos na tabela
        function renderProducts(productsToRender) {
            const tbody = document.getElementById('productsTableBody');
            if (productsToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem;">Nenhum produto encontrado</td></tr>';
            } else {
                tbody.innerHTML = productsToRender.map(product => {
                    const costPrice = parseFloat(product.cost_price || 0);
                    const salePrice = parseFloat(product.sale_price || product.price || 0);
                    const profit = salePrice - costPrice;
                    const profitPercent = costPrice > 0 ? ((profit / costPrice) * 100) : 0;
                    
                    return `
                    <tr>
                        <td>${product.barcode || '-'}</td>
                        <td>${product.name}</td>
                        <td>${product.category_name || '-'}</td>
                        <td>${product.supplier_name || '-'}</td>
                        <td>${product.stock || 0}</td>
                        <td>R$ ${costPrice.toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${salePrice.toFixed(2).replace('.', ',')}</td>
                        <td style="color: ${profit >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">
                            R$ ${profit.toFixed(2).replace('.', ',')}
                        </td>
                        <td style="color: ${profitPercent >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">
                            ${profitPercent.toFixed(2).replace('.', ',')}%
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editProduct(${product.id})">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">Excluir</button>
                        </td>
                    </tr>
                `;
                }).join('');
            }
        }

        // Abrir modal de produto
        function openProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            const title = document.getElementById('productModalTitle');
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    title.textContent = 'Editar Produto';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name || '';
                    document.getElementById('productBarcode').value = product.barcode || '';
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productCategory').value = product.category_id || '';
                    document.getElementById('productSupplier').value = product.supplier_id || '';
                    document.getElementById('productPrice').value = product.sale_price || product.price || '';
                    document.getElementById('productCost').value = product.cost_price || '';
                    document.getElementById('productStock').value = product.stock || 0;
                    document.getElementById('productMinStock').value = product.min_stock || 0;
                }
            } else {
                title.textContent = 'Novo Produto';
                form.reset();
                document.getElementById('productId').value = '';
            }
            
            // Inicializar leitor de c√≥digo de barras para o campo do produto (modo cadastro)
            const barcodeInput = document.getElementById('productBarcode');
            if (barcodeInput && typeof BarcodeReader !== 'undefined') {
                if (!productBarcodeReader) {
                    productBarcodeReader = new BarcodeReader(
                        barcodeInput,
                        (barcode) => {
                            // Apenas garantir que o campo fique com o c√≥digo lido
                            barcodeInput.value = barcode;
                        },
                        { lookupProduct: false, autoFocus: false }
                    );
                }
            }

            modal.style.display = 'block';
        }

        // Fechar modal
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            document.getElementById('productForm').reset();
        }

        // Helper para obter headers com token
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }

        // Gerar c√≥digo de barras √∫nico
        async function generateUniqueBarcode() {
            const barcodeInput = document.getElementById('productBarcode');
            const generateBtn = document.getElementById('generateBarcodeBtn');
            
            // Desabilitar bot√£o durante gera√ß√£o
            generateBtn.disabled = true;
            generateBtn.textContent = 'Gerando...';
            
            try {
                let attempts = 0;
                let newBarcode = '';
                let isUnique = false;
                
                while (!isUnique && attempts < 10) {
                    // Gerar c√≥digo aleat√≥rio de 8 d√≠gitos
                    newBarcode = Math.floor(10000000 + Math.random() * 90000000).toString();
                    
                    // Verificar se j√° existe
                    try {
                        const existing = await fetch(`/api/products/barcode/${newBarcode}`, {
                            headers: getAuthHeaders()
                        });
                        if (existing.status === 404) {
                            // C√≥digo n√£o existe, pode usar
                            isUnique = true;
                        } else if (existing.ok) {
                            // C√≥digo existe, tentar outro
                            attempts++;
                        }
                    } catch (error) {
                        // Erro na verifica√ß√£o (404 √© esperado quando n√£o existe)
                        // Se for 404, c√≥digo n√£o existe e pode usar
                        if (error.message && error.message.includes('404')) {
                            isUnique = true;
                        } else {
                            // Outro erro, tentar novamente
                            attempts++;
                        }
                    }
                }
                
                if (isUnique) {
                    barcodeInput.value = newBarcode;
                    barcodeInput.focus();
                } else {
                    alert('N√£o foi poss√≠vel gerar um c√≥digo √∫nico. Tente novamente.');
                }
            } catch (error) {
                console.error('Erro ao gerar c√≥digo:', error);
                alert('Erro ao gerar c√≥digo de barras');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'üîÑ Gerar';
            }
        }

        // Criar ou buscar categoria
        async function getOrCreateCategory(categoryName) {
            if (!categoryName || categoryName.trim() === '') {
                return null;
            }
            
            try {
                // Buscar categoria existente
                const searchResponse = await fetch(`/api/categories?search=${encodeURIComponent(categoryName)}`, {
                    headers: getAuthHeaders()
                });
                if (searchResponse.ok) {
                    const categories = await searchResponse.json();
                    const existing = categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                    if (existing) {
                        return existing.id;
                    }
                }
                
                // Criar nova categoria
                const createResponse = await fetch('/api/categories', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ name: categoryName.trim() })
                });
                
                if (createResponse.ok) {
                    const newCategory = await createResponse.json();
                    return newCategory.id;
                }
            } catch (error) {
                console.error('Erro ao criar/buscar categoria:', error);
            }
            
            return null;
        }

        // Salvar produto
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const categoryId = document.getElementById('productCategory').value || null;
            const supplierId = document.getElementById('productSupplier').value || null;
            
            const productData = {
                name: document.getElementById('productName').value,
                barcode: document.getElementById('productBarcode').value || null,
                description: document.getElementById('productDescription').value || null,
                category_id: categoryId ? parseInt(categoryId) : null,
                supplier_id: supplierId ? parseInt(supplierId) : null,
                sale_price: parseFloat(document.getElementById('productPrice').value),
                cost_price: parseFloat(document.getElementById('productCost').value) || 0,
                stock: parseInt(document.getElementById('productStock').value) || 0,
                min_stock: parseInt(document.getElementById('productMinStock').value) || 0
            };

            try {
                let response;
                if (productId) {
                    response = await fetch(`/api/products/${productId}`, {
                        method: 'PUT',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(productData)
                    });
                } else {
                    response = await fetch('/api/products', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(productData)
                    });
                }

                if (response.ok) {
                    closeProductModal();
                    // Recarregar produtos com filtros atuais
                    const searchTerm = document.getElementById('searchProduct').value.trim();
                    const categoryId = document.getElementById('filterCategory').value;
                    const supplierId = document.getElementById('filterSupplier').value;
                    await loadProducts(searchTerm, categoryId, supplierId);
                    alert(productId ? 'Produto atualizado com sucesso!' : 'Produto criado com sucesso!');
                } else {
                    const error = await response.json();
                    alert('Erro: ' + (error.error || 'Erro ao salvar produto'));
                }
            } catch (error) {
                console.error('Erro ao salvar produto:', error);
                alert('Erro ao salvar produto');
            }
        });

        // Editar produto
        function editProduct(id) {
            openProductModal(id);
        }

        // Deletar produto
        async function deleteProduct(id) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) return;
            
            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const searchTerm = document.getElementById('searchProduct').value.trim();
                    const categoryId = document.getElementById('filterCategory').value;
                    const supplierId = document.getElementById('filterSupplier').value;
                    await loadProducts(searchTerm, categoryId, supplierId);
                    alert('Produto exclu√≠do com sucesso!');
                } else {
                    alert('Erro ao excluir produto');
                }
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                alert('Erro ao excluir produto');
            }
        }

        // Event listeners
        document.getElementById('addProductBtn').addEventListener('click', () => openProductModal());
        
        // Busca de produtos
        let searchTimeout;
        document.getElementById('searchProduct').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const searchTerm = e.target.value.trim();
            const categoryId = document.getElementById('filterCategory').value;
            const supplierId = document.getElementById('filterSupplier').value;
            
            searchTimeout = setTimeout(() => {
                loadProducts(searchTerm, categoryId, supplierId);
            }, 300); // Aguardar 300ms ap√≥s parar de digitar
        });

        // Filtro por categoria
        document.getElementById('filterCategory').addEventListener('change', function(e) {
            const categoryId = e.target.value;
            const searchTerm = document.getElementById('searchProduct').value.trim();
            const supplierId = document.getElementById('filterSupplier').value;
            loadProducts(searchTerm, categoryId, supplierId);
        });

        // Filtro por fornecedor
        document.getElementById('filterSupplier').addEventListener('change', function(e) {
            const supplierId = e.target.value;
            const searchTerm = document.getElementById('searchProduct').value.trim();
            const categoryId = document.getElementById('filterCategory').value;
            loadProducts(searchTerm, categoryId, supplierId);
        });

        // ========================================
        // DEVOLU√á√ïES
        // ========================================

        let returns = [];
        let selectedSale = null;

        // Abrir modal de devolu√ß√µes
        document.getElementById('returnsBtn')?.addEventListener('click', function() {
            openReturnsModal();
        });

        function openReturnsModal() {
            document.getElementById('returnsModal').style.display = 'block';
            loadReturns();
        }

        function closeReturnsModal() {
            document.getElementById('returnsModal').style.display = 'none';
        }

        // Carregar devolu√ß√µes
        async function loadReturns() {
            try {
                console.log('üì• Carregando devolu√ß√µes...');
                const response = await api.getReturns();
                console.log('‚úÖ Resposta recebida:', response);
                
                // Garantir que √© um array
                if (Array.isArray(response)) {
                    returns = response;
                } else if (response && Array.isArray(response.data)) {
                    returns = response.data;
                } else if (response && response.returns && Array.isArray(response.returns)) {
                    returns = response.returns;
                } else {
                    console.warn('‚ö†Ô∏è Resposta n√£o √© um array, usando array vazio');
                    returns = [];
                }
                
                console.log('‚úÖ Devolu√ß√µes processadas:', returns.length);
                renderReturns();
            } catch (error) {
                console.error('‚ùå Erro ao carregar devolu√ß√µes:', error);
                console.error('‚ùå Tipo do erro:', typeof error);
                console.error('‚ùå Detalhes do erro:', error);
                
                // Se for erro de rede ou servidor, mostrar mensagem amig√°vel
                if (error.message && error.message.includes('Failed to fetch')) {
                    alert('Erro de conex√£o com o servidor. Verifique sua conex√£o e tente novamente.');
                } else {
                    // Tentar obter mensagem de erro mais detalhada
                    let errorMessage = 'Erro ao carregar devolu√ß√µes';
                    if (error.details) {
                        errorMessage = error.details;
                    } else if (error.error) {
                        errorMessage = error.error;
                    } else if (error.message) {
                        errorMessage = error.message;
                    } else if (typeof error === 'string') {
                        errorMessage = error;
                    }
                    
                    alert(errorMessage);
                }
                
                // Renderizar tabela vazia mesmo com erro
                returns = [];
                renderReturns();
            }
        }

        // Renderizar devolu√ß√µes
        function renderReturns() {
            const tbody = document.getElementById('returnsTableBody');
            if (!tbody) return;

            if (returns.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 2rem;">
                            Nenhuma devolu√ß√£o registrada
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = returns.map(returnItem => {
                const statusBadge = {
                    'pending': '<span style="background: #fbbf24; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">Pendente</span>',
                    'completed': '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">Conclu√≠da</span>',
                    'cancelled': '<span style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">Cancelada</span>'
                }[returnItem.status] || returnItem.status;

                const actionText = {
                    'same_product': 'Troca pelo mesmo',
                    'different_product': returnItem.replacement_product_name ? `Troca por: ${returnItem.replacement_product_name}` : 'Troca por outro',
                    'refund': 'Reembolso'
                }[returnItem.action_type] || returnItem.action_type;

                const priceDiff = returnItem.price_difference || 0;
                const priceDiffText = priceDiff > 0 
                    ? `<span style="color: #ef4444;">+R$ ${priceDiff.toFixed(2)}</span>` 
                    : priceDiff < 0 
                        ? `<span style="color: #10b981;">R$ ${priceDiff.toFixed(2)}</span>` 
                        : 'Sem diferen√ßa';

                return `
                    <tr>
                        <td>${returnItem.return_number}</td>
                        <td>${new Date(returnItem.created_at).toLocaleDateString('pt-BR')}</td>
                        <td>${returnItem.customer_name || 'N/A'}</td>
                        <td>${returnItem.product_name}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${returnItem.defect_description}">${returnItem.defect_description}</td>
                        <td>${actionText}</td>
                        <td>R$ ${parseFloat(returnItem.original_price).toFixed(2)}</td>
                        <td>${returnItem.original_payment_method}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${returnItem.status === 'pending' ? `
                                <button class="btn btn-sm btn-primary" onclick="processReturn(${returnItem.id})">Processar</button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelReturn(${returnItem.id})">Cancelar</button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="viewReturnDetails(${returnItem.id})">Detalhes</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Abrir modal de nova devolu√ß√£o
        document.getElementById('addReturnBtn')?.addEventListener('click', function() {
            openReturnFormModal();
        });

        function openReturnFormModal() {
            document.getElementById('returnFormModal').style.display = 'block';
            document.getElementById('returnForm').reset();
            document.getElementById('returnId').value = '';
            document.getElementById('saleInfoContainer').style.display = 'none';
            document.getElementById('replacementProductContainer').style.display = 'none';
            document.getElementById('returnFormTitle').textContent = 'Nova Devolu√ß√£o';
            selectedSale = null;
            loadProductsForReplacement();
        }

        function closeReturnFormModal() {
            document.getElementById('returnFormModal').style.display = 'none';
        }

        // Buscar venda para devolu√ß√£o
        async function searchSaleForReturn() {
            const searchTerm = document.getElementById('returnSaleSearch').value.trim();
            if (!searchTerm) {
                alert('Digite o n√∫mero da venda ou c√≥digo de barras');
                return;
            }

            try {
                // Tentar buscar por n√∫mero da venda primeiro
                let sale = null;
                try {
                    const sales = await api.getSales();
                    sale = sales.find(s => s.sale_number === searchTerm || s.id.toString() === searchTerm);
                } catch (e) {
                    console.log('Erro ao buscar por n√∫mero da venda:', e);
                }

                // Se n√£o encontrou, tentar buscar por c√≥digo de barras do produto
                if (!sale) {
                    const product = await api.getProductByBarcode(searchTerm);
                    if (product) {
                        // Buscar vendas que cont√™m este produto
                        const sales = await api.getSales();
                        for (const s of sales) {
                            const saleDetails = await api.getSale(s.id);
                            if (saleDetails.items && saleDetails.items.some(item => item.product_id === product.id)) {
                                sale = saleDetails;
                                break;
                            }
                        }
                    }
                }

                if (!sale) {
                    alert('Venda n√£o encontrada');
                    return;
                }

                selectedSale = sale;
                displaySaleInfo(sale);
            } catch (error) {
                console.error('Erro ao buscar venda:', error);
                alert('Erro ao buscar venda');
            }
        }

        // Exibir informa√ß√µes da venda
        async function displaySaleInfo(sale) {
            const container = document.getElementById('saleInfoContainer');
            const content = document.getElementById('saleInfoContent');
            
            // Buscar detalhes completos da venda
            const saleDetails = await api.getSale(sale.id);
            
            document.getElementById('returnSaleId').value = saleDetails.id;
            document.getElementById('returnCustomerId').value = saleDetails.customer_id || '';
            document.getElementById('returnOriginalPaymentMethod').value = saleDetails.payment_method;

            let itemsHtml = '<p><strong>Venda:</strong> ' + saleDetails.sale_number + '</p>';
            itemsHtml += '<p><strong>Cliente:</strong> ' + (saleDetails.customer_name || 'N√£o informado') + '</p>';
            itemsHtml += '<p><strong>Forma de Pagamento:</strong> ' + saleDetails.payment_method + '</p>';
            itemsHtml += '<p><strong>Itens da Venda:</strong></p>';
            itemsHtml += '<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">';
            
            saleDetails.items.forEach((item, index) => {
                itemsHtml += `<li id="sale-item-${item.id}" style="margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${item.product_name}</strong><br>
                            <small style="color: #718096;">
                                Quantidade: ${item.quantity} | 
                                Pre√ßo Unit√°rio: R$ ${parseFloat(item.unit_price).toFixed(2)} | 
                                Total: R$ ${(parseFloat(item.unit_price) * item.quantity).toFixed(2)}
                            </small>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="selectSaleItem(${item.id}, ${item.product_id}, ${item.unit_price})" style="margin-left: 0.5rem;">
                            Selecionar
                        </button>
                    </div>
                </li>`;
            });
            
            itemsHtml += '</ul>';
            content.innerHTML = itemsHtml;
            container.style.display = 'block';
        }

        // Selecionar item da venda
        function selectSaleItem(saleItemId, productId, price) {
            document.getElementById('returnSaleItemId').value = saleItemId;
            document.getElementById('returnProductId').value = productId;
            document.getElementById('returnOriginalPrice').value = price;
            
            // Destacar o item selecionado visualmente
            const items = document.querySelectorAll('#saleInfoContent li');
            items.forEach(item => {
                item.style.background = '';
                item.style.padding = '';
                item.style.borderRadius = '';
            });
            
            // Encontrar e destacar o item selecionado
            const selectedButton = event.target;
            const selectedItem = selectedButton.closest('li');
            if (selectedItem) {
                selectedItem.style.background = '#e6fffa';
                selectedItem.style.padding = '0.5rem';
                selectedItem.style.borderRadius = '4px';
                selectedItem.style.border = '2px solid #10b981';
                
                // Mudar o bot√£o para mostrar que foi selecionado
                selectedButton.textContent = '‚úì Selecionado';
                selectedButton.style.background = '#10b981';
                selectedButton.disabled = true;
            }
            
            // Desabilitar outros bot√µes de sele√ß√£o
            items.forEach(item => {
                const btn = item.querySelector('button');
                if (btn && btn !== selectedButton) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                }
            });
        }

        // Carregar produtos para substitui√ß√£o
        async function loadProductsForReplacement() {
            try {
                const products = await api.getProducts();
                const select = document.getElementById('returnReplacementProduct');
                select.innerHTML = '<option value="">Selecione o produto...</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - R$ ${parseFloat(product.price).toFixed(2)}`;
                    option.dataset.price = product.price;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
            }
        }

        // Lidar com mudan√ßa de tipo de a√ß√£o
        function handleReturnActionTypeChange() {
            const actionType = document.getElementById('returnActionType').value;
            const replacementContainer = document.getElementById('replacementProductContainer');
            const priceDiffInfo = document.getElementById('priceDifferenceInfo');
            
            if (actionType === 'different_product') {
                replacementContainer.style.display = 'block';
                document.getElementById('returnReplacementProduct').required = true;
            } else {
                replacementContainer.style.display = 'none';
                document.getElementById('returnReplacementProduct').required = false;
                priceDiffInfo.style.display = 'none';
            }

            // Calcular diferen√ßa de pre√ßo quando produto de substitui√ß√£o for selecionado
            if (actionType === 'different_product') {
                document.getElementById('returnReplacementProduct').addEventListener('change', function() {
                    const originalPrice = parseFloat(document.getElementById('returnOriginalPrice').value) || 0;
                    const replacementProductId = this.value;
                    if (replacementProductId) {
                        const selectedOption = this.options[this.selectedIndex];
                        const replacementPrice = parseFloat(selectedOption.dataset.price) || 0;
                        const difference = replacementPrice - originalPrice;
                        
                        document.getElementById('priceDifferenceValue').innerHTML = 
                            difference > 0 
                                ? `<span style="color: #ef4444;">Cliente paga: R$ ${difference.toFixed(2)}</span>`
                                : difference < 0
                                    ? `<span style="color: #10b981;">Loja devolve: R$ ${Math.abs(difference).toFixed(2)}</span>`
                                    : 'Sem diferen√ßa';
                        priceDiffInfo.style.display = 'block';
                    } else {
                        priceDiffInfo.style.display = 'none';
                    }
                });
            }
        }

        // Salvar devolu√ß√£o
        document.getElementById('returnForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const saleId = document.getElementById('returnSaleId').value;
            const saleItemId = document.getElementById('returnSaleItemId').value;
            const productId = document.getElementById('returnProductId').value;
            const defectDescription = document.getElementById('returnDefectDescription').value;
            const actionType = document.getElementById('returnActionType').value;
            const replacementProductId = document.getElementById('returnReplacementProduct').value;
            const observations = document.getElementById('returnObservations').value;

            if (!saleId || !saleItemId || !productId) {
                alert('Selecione um item da venda primeiro');
                return;
            }

            try {
                const returnData = {
                    sale_id: parseInt(saleId),
                    sale_item_id: parseInt(saleItemId),
                    product_id: parseInt(productId),
                    defect_description: defectDescription,
                    action_type: actionType,
                    replacement_product_id: actionType === 'different_product' ? parseInt(replacementProductId) : null,
                    observations: observations || null
                };

                await api.createReturn(returnData);
                alert('Devolu√ß√£o registrada com sucesso!');
                closeReturnFormModal();
                loadReturns();
            } catch (error) {
                console.error('Erro ao criar devolu√ß√£o:', error);
                alert('Erro ao criar devolu√ß√£o: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Processar devolu√ß√£o
        async function processReturn(returnId) {
            const returnItem = returns.find(r => r.id === returnId);
            if (!returnItem) return;

            if (returnItem.action_type === 'different_product' && !returnItem.replacement_product_id) {
                const replacementProductId = prompt('Digite o ID do produto de substitui√ß√£o:');
                if (!replacementProductId) return;

                try {
                    await api.processReturn(returnId, { replacement_product_id: parseInt(replacementProductId) });
                    alert('Devolu√ß√£o processada com sucesso!');
                    loadReturns();
                } catch (error) {
                    console.error('Erro ao processar devolu√ß√£o:', error);
                    alert('Erro ao processar devolu√ß√£o');
                }
            } else {
                try {
                    await api.processReturn(returnId, {});
                    alert('Devolu√ß√£o processada com sucesso!');
                    loadReturns();
                } catch (error) {
                    console.error('Erro ao processar devolu√ß√£o:', error);
                    alert('Erro ao processar devolu√ß√£o');
                }
            }
        }

        // Cancelar devolu√ß√£o
        async function cancelReturn(returnId) {
            if (!confirm('Tem certeza que deseja cancelar esta devolu√ß√£o?')) return;

            try {
                await api.cancelReturn(returnId);
                alert('Devolu√ß√£o cancelada com sucesso!');
                loadReturns();
            } catch (error) {
                console.error('Erro ao cancelar devolu√ß√£o:', error);
                alert('Erro ao cancelar devolu√ß√£o');
            }
        }

        // Ver detalhes da devolu√ß√£o
        async function viewReturnDetails(returnId) {
            try {
                const returnItem = await api.getReturn(returnId);
                let details = `Devolu√ß√£o: ${returnItem.return_number}\n\n`;
                details += `Cliente: ${returnItem.customer_name || 'N/A'}\n`;
                details += `Produto: ${returnItem.product_name}\n`;
                details += `Defeito: ${returnItem.defect_description}\n`;
                details += `A√ß√£o: ${returnItem.action_type === 'same_product' ? 'Troca pelo mesmo' : returnItem.action_type === 'different_product' ? 'Troca por outro' : 'Reembolso'}\n`;
                details += `Valor Original: R$ ${parseFloat(returnItem.original_price).toFixed(2)}\n`;
                details += `Forma de Pagamento: ${returnItem.original_payment_method}\n`;
                
                if (returnItem.replacement_product_name) {
                    details += `Produto de Substitui√ß√£o: ${returnItem.replacement_product_name}\n`;
                    details += `Valor de Substitui√ß√£o: R$ ${parseFloat(returnItem.replacement_price).toFixed(2)}\n`;
                    details += `Diferen√ßa: R$ ${parseFloat(returnItem.price_difference).toFixed(2)}\n`;
                }
                
                if (returnItem.refund_amount) {
                    details += `Valor Reembolsado: R$ ${parseFloat(returnItem.refund_amount).toFixed(2)}\n`;
                }
                
                details += `Status: ${returnItem.status}\n`;
                if (returnItem.processed_by_name) {
                    details += `Processado por: ${returnItem.processed_by_name}\n`;
                }
                if (returnItem.observations) {
                    details += `Observa√ß√µes: ${returnItem.observations}\n`;
                }

                alert(details);
            } catch (error) {
                console.error('Erro ao buscar detalhes:', error);
                alert('Erro ao buscar detalhes da devolu√ß√£o');
            }
        }

        // Fechar modais ao clicar fora (evitar fechar ao selecionar texto)
        window.addEventListener('click', function(event) {
            // Verificar se h√° texto selecionado
            if (window.getSelection().toString().length > 0) {
                return;
            }

            const returnsModal = document.getElementById('returnsModal');
            const returnFormModal = document.getElementById('returnFormModal');
            const quickCategoryModal = document.getElementById('quickCategoryModal');
            const quickSupplierModal = document.getElementById('quickSupplierModal');
            
            if (event.target === returnsModal) {
                closeReturnsModal();
            }
            if (event.target === returnFormModal) {
                closeReturnFormModal();
            }
            if (event.target === quickCategoryModal) {
                closeQuickCategoryModal();
            }
            if (event.target === quickSupplierModal) {
                closeQuickSupplierModal();
            }
        });

        // ========================================
        // MODAIS R√ÅPIDOS DE CATEGORIA E FORNECEDOR
        // ========================================

        // Abrir modal r√°pido de categoria
        function openQuickCategoryModal() {
            document.getElementById('quickCategoryModal').style.display = 'block';
            document.getElementById('quickCategoryForm').reset();
        }

        // Fechar modal r√°pido de categoria
        function closeQuickCategoryModal() {
            document.getElementById('quickCategoryModal').style.display = 'none';
            document.getElementById('quickCategoryForm').reset();
        }

        // Salvar categoria r√°pida
        document.getElementById('quickCategoryForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const categoryData = {
                name: document.getElementById('quickCategoryName').value,
                description: document.getElementById('quickCategoryDescription').value || null
            };
            
            try {
                const newCategory = await api.createCategory(categoryData);
                if (newCategory) {
                    // Recarregar categorias e atualizar select
                    await loadCategories();
                    // Selecionar a categoria rec√©m-criada
                    document.getElementById('productCategory').value = newCategory.id;
                    closeQuickCategoryModal();
                    alert('Categoria criada com sucesso!');
                }
            } catch (error) {
                console.error('Erro ao criar categoria:', error);
                alert('Erro ao criar categoria: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Abrir modal r√°pido de fornecedor
        function openQuickSupplierModal() {
            document.getElementById('quickSupplierModal').style.display = 'block';
            document.getElementById('quickSupplierForm').reset();
        }

        // Fechar modal r√°pido de fornecedor
        function closeQuickSupplierModal() {
            document.getElementById('quickSupplierModal').style.display = 'none';
            document.getElementById('quickSupplierForm').reset();
        }

        // Salvar fornecedor r√°pido
        document.getElementById('quickSupplierForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const supplierData = {
                name: document.getElementById('quickSupplierName').value,
                cnpj: document.getElementById('quickSupplierCnpj').value || null,
                phone: document.getElementById('quickSupplierPhone').value || null,
                email: document.getElementById('quickSupplierEmail').value || null
            };
            
            try {
                const newSupplier = await api.createSupplier(supplierData);
                if (newSupplier) {
                    // Recarregar fornecedores e atualizar select
                    await loadSuppliers();
                    // Selecionar o fornecedor rec√©m-criado
                    document.getElementById('productSupplier').value = newSupplier.id;
                    closeQuickSupplierModal();
                    alert('Fornecedor criado com sucesso!');
                }
            } catch (error) {
                console.error('Erro ao criar fornecedor:', error);
                alert('Erro ao criar fornecedor: ' + (error.message || 'Erro desconhecido'));
            }
        });
        
        // Fechar modais ao clicar fora, sem atrapalhar sele√ß√£o de texto
        window.addEventListener('click', function(event) {
            // Se o usu√°rio estiver selecionando texto, n√£o fechar os modais
            try {
                const selection = window.getSelection();
                if (selection && selection.toString().length > 0) {
                    return;
                }
            } catch (e) {
                // Ignorar erros de sele√ß√£o
            }

            const productModal = document.getElementById('productModal');
            const quickCategoryModal = document.getElementById('quickCategoryModal');
            const quickSupplierModal = document.getElementById('quickSupplierModal');

            if (event.target === productModal) {
                closeProductModal();
            }
            if (event.target === quickCategoryModal) {
                closeQuickCategoryModal();
            }
            if (event.target === quickSupplierModal) {
                closeQuickSupplierModal();
            }
        });

        // Carregar dados ao iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCategories();
            await loadSuppliers();
            await loadProducts();
        });
    </script>
</body>
</html>


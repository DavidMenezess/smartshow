name: Test Backend

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'web-site/api/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'web-site/api/**'

jobs:
  test-backend:
    name: Testes Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web-site/api

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Cache desabilitado temporariamente
          # cache: 'npm'
          # cache-dependency-path: 'package-lock.json'

      - name: Instalar dependências
        run: npm install --legacy-peer-deps

      - name: Verificar sintaxe
        run: |
          echo "Verificando sintaxe dos arquivos..."
          node --check server.js
          node --check database.js
          node --check config.js
          echo "✅ Sintaxe válida"

      - name: Verificar estrutura de rotas
        run: |
          echo "Verificando estrutura de rotas..."
          test -d routes || exit 1
          test -f routes/index.js || exit 1
          test -f routes/auth.js || exit 1
          test -f routes/products.js || exit 1
          test -f routes/sales.js || exit 1
          echo "✅ Estrutura de rotas válida"

      - name: Verificar serviços
        run: |
          echo "Verificando serviços..."
          test -d services || exit 1
          test -f services/fiscalPrinter.js || exit 1
          test -f services/pdfGenerator.js || exit 1
          echo "✅ Serviços encontrados"

      - name: Verificar dependências críticas
        run: |
          echo "Verificando dependências..."
          npm list express || exit 1
          npm list sqlite3 || exit 1
          npm list jsonwebtoken || exit 1
          echo "✅ Dependências críticas instaladas"

      - name: Teste de inicialização (dry-run)
        run: |
          echo "Testando inicialização do servidor..."
          timeout 5 node -e "
            const db = require('./database.js');
            setTimeout(() => {
              console.log('✅ Database inicializado');
              process.exit(0);
            }, 2000);
          " || echo "⚠️ Timeout esperado (servidor não deve iniciar sem configuração completa)"


name: Deploy Aplica√ß√£o

on:
  push:
    branches: [ main ]
    paths:
      - 'web-site/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

permissions:
  contents: read

env:
  AWS_REGION: "sa-east-1"

jobs:
  deploy-aplicacao:
    name: Deploy Aplica√ß√£o
    runs-on: ubuntu-latest
    # Executar mesmo se outros workflows falharem (deploy √© independente)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Debug - Informa√ß√µes do Workflow
        run: |
          echo "üîç Informa√ß√µes do Workflow:"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
          echo "Arquivos alterados:"
          git diff --name-only HEAD~1 HEAD || echo "N√£o foi poss√≠vel verificar arquivos alterados"
      
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Obter IP da EC2
        id: get-ip
        run: |
          echo "üîç Buscando inst√¢ncia EC2 na regi√£o ${{ env.AWS_REGION }}..."
          
          # Listar todas as inst√¢ncias para debug
          echo "üìã Listando todas as inst√¢ncias na regi√£o..."
          aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],PublicIpAddress,State.Name]' \
            --output table || true
          
          # Buscar inst√¢ncia pelo nome da tag (smartshow-prod)
          echo "üîç Buscando inst√¢ncia com tag Name=smartshow-prod..."
          INSTANCE_ID=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Name,Values=smartshow-prod" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text 2>/dev/null || echo "")
          
          # Se n√£o encontrou, tentar varia√ß√µes
          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" == "None" ] || [ "$INSTANCE_ID" == "null" ]; then
            echo "üîç Tentando buscar por 'smartshow*'..."
            INSTANCE_ID=$(aws ec2 describe-instances \
              --region ${{ env.AWS_REGION }} \
              --filters "Name=tag:Name,Values=smartshow*" "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text 2>/dev/null || echo "")
          fi
          
          # Se ainda n√£o encontrou, tentar buscar qualquer inst√¢ncia com tag Project=Smartshow
          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" == "None" ] || [ "$INSTANCE_ID" == "null" ]; then
            echo "üîç Tentando buscar por tag Project=Smartshow..."
            INSTANCE_ID=$(aws ec2 describe-instances \
              --region ${{ env.AWS_REGION }} \
              --filters "Name=tag:Project,Values=Smartshow" "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text 2>/dev/null || echo "")
          fi
          
          # Validar se encontrou
          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" == "None" ] || [ "$INSTANCE_ID" == "null" ]; then
            echo "‚ùå Erro: Nenhuma inst√¢ncia EC2 encontrada"
            echo "üí° Verifique:"
            echo "   1. Se a inst√¢ncia existe na regi√£o ${{ env.AWS_REGION }}"
            echo "   2. Se a inst√¢ncia est√° rodando (running)"
            echo "   3. Se a tag Name est√° configurada como 'smartshow-prod'"
            echo ""
            echo "üìã Inst√¢ncias encontradas na regi√£o:"
            aws ec2 describe-instances \
              --region ${{ env.AWS_REGION }} \
              --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],State.Name]' \
              --output table || true
            exit 1
          fi
          
          echo "‚úÖ Inst√¢ncia encontrada: $INSTANCE_ID"
          
          # Obter IP p√∫blico
          PUBLIC_IP=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --instance-ids $INSTANCE_ID \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" == "None" ] || [ "$PUBLIC_IP" == "null" ]; then
            echo "‚ùå Erro: N√£o foi poss√≠vel obter o IP p√∫blico da inst√¢ncia $INSTANCE_ID"
            echo "üí° Verifique se a inst√¢ncia tem um Elastic IP associado"
            exit 1
          fi
          
          echo "‚úÖ IP P√∫blico: $PUBLIC_IP"
          echo "ec2_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Configurar SSH
        run: |
          echo "üîê Configurando SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Criar chave SSH a partir do secret
          if [ -n "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            # Salvar chave SSH preservando quebras de linha
            echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/smartshow.pem
            chmod 600 ~/.ssh/smartshow.pem
            
            # Validar formato da chave
            echo "üîç Validando formato da chave SSH..."
            if ! head -n 1 ~/.ssh/smartshow.pem | grep -q "BEGIN.*PRIVATE KEY"; then
              echo "‚ùå Erro: Chave SSH n√£o est√° no formato correto"
              echo "üí° A chave deve come√ßar com '-----BEGIN' e terminar com '-----END'"
              echo "üìã Primeira linha da chave:"
              head -n 1 ~/.ssh/smartshow.pem
              exit 1
            fi
            
            # Verificar se a chave tem o formato correto
            if ! grep -q "END.*PRIVATE KEY" ~/.ssh/smartshow.pem; then
              echo "‚ùå Erro: Chave SSH est√° incompleta ou corrompida"
              exit 1
            fi
            
            echo "‚úÖ Chave SSH validada com sucesso"
            
            # Adicionar host aos known_hosts
            ssh-keyscan -H ${{ steps.get-ip.outputs.ec2_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true
          else
            echo "‚ùå Erro: EC2_SSH_PRIVATE_KEY n√£o configurado no GitHub Secrets"
            echo "üí° Configure o secret EC2_SSH_PRIVATE_KEY com o conte√∫do completo do arquivo .pem"
            exit 1
          fi

      - name: Atualizar aplica√ß√£o na EC2
        env:
          EC2_IP: ${{ steps.get-ip.outputs.ec2_ip }}
          EC2_INSTANCE_ID: ${{ steps.get-ip.outputs.instance_id }}
        run: |
          echo "üöÄ Atualizando aplica√ß√£o na EC2..."
          
          # Script de deploy para executar na EC2
          DEPLOY_SCRIPT=$(cat << 'DEPLOY_EOF'
            set -e
            echo "üì¶ Atualizando reposit√≥rio..."
            cd /opt/smartshow/smartshow || exit 1
            
            # Fazer backup antes de atualizar
            echo "üíæ Fazendo backup..."
            sudo cp -r web-site/api/data web-site/api/data.backup.$(date +%Y%m%d_%H%M%S) || true
            
            # Atualizar c√≥digo
            echo "üîÑ Atualizando c√≥digo do reposit√≥rio..."
            sudo git fetch origin
            sudo git reset --hard origin/main
            sudo git pull origin main || true
            
            # Corrigir propriedade
            echo "üîß Corrigindo propriedade dos arquivos..."
            sudo chown -R ubuntu:ubuntu /opt/smartshow || true
            
            # Reconstruir e reiniciar containers
            echo "üê≥ Reconstruindo containers..."
            cd web-site
            docker-compose down || true
            docker-compose build --no-cache
            docker-compose up -d
            
            # Aguardar containers iniciarem
            echo "‚è≥ Aguardando containers iniciarem..."
            sleep 10
            
            # Verificar status
            echo "‚úÖ Verificando status dos containers..."
            docker-compose ps
            
            echo "üéâ Deploy conclu√≠do com sucesso!"
          DEPLOY_EOF
          )
          
          # Tentar usar AWS SSM (mais seguro, n√£o requer SSH)
          echo "üîê Tentando usar AWS Systems Manager (SSM)..."
          
          # Criar arquivo tempor√°rio com o script
          echo "$DEPLOY_SCRIPT" > /tmp/deploy-script.sh
          
          # Converter script em array JSON para SSM
          DEPLOY_COMMANDS="cd /opt/smartshow/smartshow || exit 1
sudo cp -r web-site/api/data web-site/api/data.backup.\$(date +%Y%m%d_%H%M%S) || true
sudo git fetch origin
sudo git reset --hard origin/main
sudo git pull origin main || true
sudo chown -R ubuntu:ubuntu /opt/smartshow || true
cd web-site
docker-compose down || true
docker-compose build --no-cache
docker-compose up -d
sleep 10
docker-compose ps"
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[$(echo "$DEPLOY_COMMANDS" | jq -Rs 'split("\n") | map(select(length > 0))')]" \
            --region ${{ env.AWS_REGION }} \
            --query "Command.CommandId" \
            --output text 2>/dev/null || echo "")
          
          # Se jq n√£o estiver dispon√≠vel, usar m√©todo alternativo
          if [ -z "$COMMAND_ID" ] || [ "$COMMAND_ID" == "None" ]; then
            COMMAND_ID=$(aws ssm send-command \
              --instance-ids "$EC2_INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --parameters commands="cd /opt/smartshow/smartshow || exit 1","sudo cp -r web-site/api/data web-site/api/data.backup.\$(date +%Y%m%d_%H%M%S) || true","sudo git fetch origin","sudo git reset --hard origin/main","sudo git pull origin main || true","sudo chown -R ubuntu:ubuntu /opt/smartshow || true","cd web-site","docker-compose down || true","docker-compose build --no-cache","docker-compose up -d","sleep 10","docker-compose ps" \
              --region ${{ env.AWS_REGION }} \
              --query "Command.CommandId" \
              --output text 2>/dev/null || echo "")
          fi
          
          if [ -n "$COMMAND_ID" ] && [ "$COMMAND_ID" != "None" ]; then
            echo "‚úÖ Comando SSM enviado: $COMMAND_ID"
            echo "‚è≥ Aguardando execu√ß√£o (60 segundos)..."
            sleep 60
            
            # Obter resultado
            OUTPUT=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query "StandardOutputContent" \
              --output text 2>/dev/null || echo "")
            
            ERROR_OUTPUT=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query "StandardErrorContent" \
              --output text 2>/dev/null || echo "")
            
            echo "üìã Sa√≠da do comando:"
            echo "$OUTPUT"
            
            if [ -n "$ERROR_OUTPUT" ]; then
              echo "‚ö†Ô∏è Erros:"
              echo "$ERROR_OUTPUT"
            fi
            
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query "Status" \
              --output text 2>/dev/null || echo "Unknown")
            
            if [ "$STATUS" != "Success" ]; then
              echo "‚ùå Deploy falhou com status: $STATUS"
              echo "üí° Tentando m√©todo alternativo via SSH..."
              
              # Fallback para SSH
              if [ -f ~/.ssh/smartshow.pem ]; then
                SSH_CMD="ssh -i ~/.ssh/smartshow.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@$EC2_IP"
                $SSH_CMD << 'SSH_EOF'
                  set -e
                  echo "üì¶ Atualizando reposit√≥rio..."
                  cd /opt/smartshow/smartshow || exit 1
                  sudo git fetch origin
                  sudo git reset --hard origin/main
                  sudo git pull origin main || true
                  sudo chown -R ubuntu:ubuntu /opt/smartshow || true
                  cd web-site
                  docker-compose down || true
                  docker-compose build --no-cache
                  docker-compose up -d
                  sleep 10
                  docker-compose ps
                  echo "üéâ Deploy conclu√≠do com sucesso!"
                SSH_EOF
              else
                echo "‚ùå SSM falhou e SSH n√£o est√° dispon√≠vel"
                echo "üí° Configure o secret EC2_SSH_PRIVATE_KEY no GitHub ou habilite SSM na EC2"
                exit 1
              fi
            else
              echo "‚úÖ Deploy via SSM conclu√≠do com sucesso!"
            fi
          else
            echo "‚ö†Ô∏è SSM n√£o dispon√≠vel, tentando SSH..."
            
            # Fallback para SSH
            if [ -f ~/.ssh/smartshow.pem ]; then
              SSH_CMD="ssh -i ~/.ssh/smartshow.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@$EC2_IP"
              $SSH_CMD << 'SSH_EOF'
                set -e
                echo "üì¶ Atualizando reposit√≥rio..."
                cd /opt/smartshow/smartshow || exit 1
                sudo cp -r web-site/api/data web-site/api/data.backup.$(date +%Y%m%d_%H%M%S) || true
                sudo git fetch origin
                sudo git reset --hard origin/main
                sudo git pull origin main || true
                sudo chown -R ubuntu:ubuntu /opt/smartshow || true
                cd web-site
                docker-compose down || true
                docker-compose build --no-cache
                docker-compose up -d
                sleep 10
                docker-compose ps
                echo "üéâ Deploy conclu√≠do com sucesso!"
              SSH_EOF
            else
              echo "‚ùå Nenhum m√©todo de acesso dispon√≠vel"
              echo "üí° Configure uma das op√ß√µes:"
              echo "   1. Habilite AWS Systems Manager na EC2 (recomendado)"
              echo "   2. Configure o secret EC2_SSH_PRIVATE_KEY no GitHub"
              exit 1
            fi
          fi

      - name: Verificar deploy
        run: |
          echo "üîç Verificando se a aplica√ß√£o est√° respondendo..."
          sleep 5
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ steps.get-ip.outputs.ec2_ip }}:3000/api/health || echo "000")
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "‚úÖ Aplica√ß√£o est√° respondendo corretamente!"
            echo "üåê URL: http://${{ steps.get-ip.outputs.ec2_ip }}:3000"
          else
            echo "‚ö†Ô∏è Aplica√ß√£o pode n√£o estar respondendo (HTTP $HTTP_CODE)"
            echo "üí° Verifique os logs: ssh -i ~/.ssh/smartshow.pem ubuntu@${{ steps.get-ip.outputs.ec2_ip }} 'cd /opt/smartshow/smartshow/web-site && docker-compose logs'"
          fi

      - name: Resumo do Deploy
        if: always()
        run: |
          echo "## üöÄ Deploy Conclu√≠do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**IP da EC2:** \`${{ steps.get-ip.outputs.ec2_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL da Aplica√ß√£o:** http://${{ steps.get-ip.outputs.ec2_ip }}:3000" >> $GITHUB_STEP_SUMMARY
          echo "**Inst√¢ncia:** \`${{ steps.get-ip.outputs.instance_id }}\`" >> $GITHUB_STEP_SUMMARY

name: Deploy AplicaÃ§Ã£o

on:
  push:
    branches: [ main ]
    paths:
      - 'web-site/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

permissions:
  contents: read

env:
  AWS_REGION: "sa-east-1"

jobs:
  deploy-aplicacao:
    name: Deploy AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    # Executar mesmo se outros workflows falharem (deploy Ã© independente)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Debug - InformaÃ§Ãµes do Workflow
        run: |
          echo "ðŸ” InformaÃ§Ãµes do Workflow:"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
          echo "Arquivos alterados:"
          git diff --name-only HEAD~1 HEAD || echo "NÃ£o foi possÃ­vel verificar arquivos alterados"
      
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Obter IP da EC2
        id: get-ip
        run: |
          echo "ðŸ” Buscando instÃ¢ncia EC2 na regiÃ£o ${{ env.AWS_REGION }}..."
          
          # Listar todas as instÃ¢ncias para debug
          echo "ðŸ“‹ Listando todas as instÃ¢ncias na regiÃ£o..."
          aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],PublicIpAddress,State.Name]' \
            --output table || true
          
          # Buscar instÃ¢ncia pelo nome da tag (smartshow-prod)
          echo "ðŸ” Buscando instÃ¢ncia com tag Name=smartshow-prod..."
          INSTANCE_ID=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Name,Values=smartshow-prod" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text 2>/dev/null || echo "")
          
          # Se nÃ£o encontrou, tentar variaÃ§Ãµes
          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" == "None" ] || [ "$INSTANCE_ID" == "null" ]; then
            echo "ðŸ” Tentando buscar por 'smartshow*'..."
            INSTANCE_ID=$(aws ec2 describe-instances \
              --region ${{ env.AWS_REGION }} \
              --filters "Name=tag:Name,Values=smartshow*" "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text 2>/dev/null || echo "")
          fi
          
          # Se ainda nÃ£o encontrou, tentar buscar qualquer instÃ¢ncia com tag Project=Smartshow
          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" == "None" ] || [ "$INSTANCE_ID" == "null" ]; then
            echo "ðŸ” Tentando buscar por tag Project=Smartshow..."
            INSTANCE_ID=$(aws ec2 describe-instances \
              --region ${{ env.AWS_REGION }} \
              --filters "Name=tag:Project,Values=Smartshow" "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text 2>/dev/null || echo "")
          fi
          
          # Validar se encontrou
          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" == "None" ] || [ "$INSTANCE_ID" == "null" ]; then
            echo "âŒ Erro: Nenhuma instÃ¢ncia EC2 encontrada"
            echo "ðŸ’¡ Verifique:"
            echo "   1. Se a instÃ¢ncia existe na regiÃ£o ${{ env.AWS_REGION }}"
            echo "   2. Se a instÃ¢ncia estÃ¡ rodando (running)"
            echo "   3. Se a tag Name estÃ¡ configurada como 'smartshow-prod'"
            echo ""
            echo "ðŸ“‹ InstÃ¢ncias encontradas na regiÃ£o:"
            aws ec2 describe-instances \
              --region ${{ env.AWS_REGION }} \
              --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],State.Name]' \
              --output table || true
            exit 1
          fi
          
          echo "âœ… InstÃ¢ncia encontrada: $INSTANCE_ID"
          
          # Obter IP pÃºblico
          PUBLIC_IP=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --instance-ids $INSTANCE_ID \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" == "None" ] || [ "$PUBLIC_IP" == "null" ]; then
            echo "âŒ Erro: NÃ£o foi possÃ­vel obter o IP pÃºblico da instÃ¢ncia $INSTANCE_ID"
            echo "ðŸ’¡ Verifique se a instÃ¢ncia tem um Elastic IP associado"
            exit 1
          fi
          
          echo "âœ… IP PÃºblico: $PUBLIC_IP"
          echo "ec2_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Configurar SSH
        run: |
          echo "ðŸ” Configurando SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Criar chave SSH a partir do secret
          if [ -n "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            # Salvar chave SSH preservando quebras de linha
            echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/smartshow.pem
            chmod 600 ~/.ssh/smartshow.pem
            
            # Validar formato da chave
            echo "ðŸ” Validando formato da chave SSH..."
            if ! head -n 1 ~/.ssh/smartshow.pem | grep -q "BEGIN.*PRIVATE KEY"; then
              echo "âŒ Erro: Chave SSH nÃ£o estÃ¡ no formato correto"
              echo "ðŸ’¡ A chave deve comeÃ§ar com '-----BEGIN' e terminar com '-----END'"
              echo "ðŸ“‹ Primeira linha da chave:"
              head -n 1 ~/.ssh/smartshow.pem
              exit 1
            fi
            
            # Verificar se a chave tem o formato correto
            if ! grep -q "END.*PRIVATE KEY" ~/.ssh/smartshow.pem; then
              echo "âŒ Erro: Chave SSH estÃ¡ incompleta ou corrompida"
              exit 1
            fi
            
            echo "âœ… Chave SSH validada com sucesso"
            
            # Adicionar host aos known_hosts
            ssh-keyscan -H ${{ steps.get-ip.outputs.ec2_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true
          else
            echo "âŒ Erro: EC2_SSH_PRIVATE_KEY nÃ£o configurado no GitHub Secrets"
            echo "ðŸ’¡ Configure o secret EC2_SSH_PRIVATE_KEY com o conteÃºdo completo do arquivo .pem"
            exit 1
          fi

      - name: Atualizar aplicaÃ§Ã£o na EC2
        env:
          EC2_IP: ${{ steps.get-ip.outputs.ec2_ip }}
          EC2_INSTANCE_ID: ${{ steps.get-ip.outputs.instance_id }}
        run: |
          echo "ðŸš€ Atualizando aplicaÃ§Ã£o na EC2..."
          
          # Tentar usar AWS SSM (mais seguro, nÃ£o requer SSH)
          echo "ðŸ” Tentando usar AWS Systems Manager (SSM)..."
          
          # Converter script em array JSON para SSM
          # Usar array direto para evitar problemas com YAML
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters '{"commands":["cd /opt/smartshow/smartshow || exit 1","sudo cp -r web-site/api/data web-site/api/data.backup.$(date +%Y%m%d_%H%M%S) || true","sudo git fetch origin","sudo git reset --hard origin/main","sudo git pull origin main || true","sudo chown -R ubuntu:ubuntu /opt/smartshow || true","cd web-site","chmod +x cleanup-containers.sh || true","./cleanup-containers.sh || bash -c \"docker-compose down -v --remove-orphans || true; docker stop smartshow-api web-site-smartshow-api-1 2>/dev/null || true; docker rm -f smartshow-api web-site-smartshow-api-1 2>/dev/null || true; for c in $(docker ps -aq --filter name=smartshow-api --filter name=web-site-smartshow-api); do docker rm -f $c || true; done; docker ps -a --format '\''{{.Names}} {{.ID}}'\'' | grep -E '\''(smartshow|web-site)'\'' | awk '\''{print $2}'\'' | xargs -r docker rm -f 2>/dev/null || true; docker container prune -f || true; docker network rm web-site_loja-network loja-network 2>/dev/null || true; docker network prune -f || true; sleep 5\"","echo \"ðŸ” Verificando se ainda hÃ¡ containers problemÃ¡ticos...\"","docker ps -a --format '\''{{.Names}}'\'' | grep -qE '\''(web-site-smartshow-api|smartshow-api)'\'' && (echo \"âš ï¸ Ainda hÃ¡ containers problemÃ¡ticos, removendo...\" && docker ps -a --format '\''{{.Names}} {{.ID}}'\'' | grep -E '\''(web-site-smartshow-api|smartshow-api)'\'' | awk '\''{print $2}'\'' | xargs -r docker kill 2>/dev/null || true && docker ps -a --format '\''{{.Names}} {{.ID}}'\'' | grep -E '\''(web-site-smartshow-api|smartshow-api)'\'' | awk '\''{print $2}'\'' | xargs -r docker rm -f && sleep 2) || echo \"âœ… Nenhum container problemÃ¡tico encontrado\"","echo \"ðŸ”¨ Construindo imagens...\"","docker-compose build --no-cache","echo \"ðŸš€ Garantindo que nÃ£o hÃ¡ containers antes de iniciar...\"","docker-compose down --remove-orphans 2>/dev/null || true","sleep 2","echo \"ðŸš€ Iniciando containers (forÃ§ando recriaÃ§Ã£o)...\"","docker-compose up -d --force-recreate --remove-orphans","sleep 10","docker-compose ps"]}' \
            --region ${{ env.AWS_REGION }} \
            --query "Command.CommandId" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$COMMAND_ID" ] && [ "$COMMAND_ID" != "None" ]; then
            echo "âœ… Comando SSM enviado: $COMMAND_ID"
            echo "â³ Aguardando execuÃ§Ã£o (60 segundos)..."
            sleep 60
            
            # Obter resultado
            OUTPUT=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query "StandardOutputContent" \
              --output text 2>/dev/null || echo "")
            
            ERROR_OUTPUT=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query "StandardErrorContent" \
              --output text 2>/dev/null || echo "")
            
            echo "ðŸ“‹ SaÃ­da do comando:"
            echo "$OUTPUT"
            
            if [ -n "$ERROR_OUTPUT" ]; then
              echo "âš ï¸ Erros:"
              echo "$ERROR_OUTPUT"
            fi
            
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query "Status" \
              --output text 2>/dev/null || echo "Unknown")
            
            if [ "$STATUS" != "Success" ]; then
              echo "âŒ Deploy falhou com status: $STATUS"
              echo "ðŸ’¡ Tentando mÃ©todo alternativo via SSH..."
              
              # Fallback para SSH
              if [ -f ~/.ssh/smartshow.pem ]; then
                ssh -i ~/.ssh/smartshow.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@$EC2_IP "set -e && echo 'ðŸ“¦ Atualizando repositÃ³rio...' && cd /opt/smartshow/smartshow || exit 1 && sudo git fetch origin && sudo git reset --hard origin/main && sudo git pull origin main || true && sudo chown -R ubuntu:ubuntu /opt/smartshow || true && cd web-site && chmod +x cleanup-containers.sh || true && ./cleanup-containers.sh || bash -c 'docker-compose down -v --remove-orphans || true; docker stop smartshow-api web-site-smartshow-api-1 2>/dev/null || true; docker rm -f smartshow-api web-site-smartshow-api-1 2>/dev/null || true; for c in \$(docker ps -aq --filter name=smartshow-api --filter name=web-site-smartshow-api); do docker rm -f \$c || true; done; docker ps -a --format \"{{.Names}} {{.ID}}\" | grep -E \"(smartshow|web-site)\" | awk \"{print \\\$2}\" | xargs -r docker rm -f 2>/dev/null || true; docker container prune -f || true; docker network rm web-site_loja-network loja-network 2>/dev/null || true; docker network prune -f || true; sleep 5' && echo 'ðŸ” Verificando se ainda hÃ¡ containers problemÃ¡ticos...' && (docker ps -a --format '{{.Names}}' | grep -qE '(web-site-smartshow-api|smartshow-api)' && (echo 'âš ï¸ Ainda hÃ¡ containers problemÃ¡ticos, removendo...' && docker ps -a --format '{{.Names}} {{.ID}}' | grep -E '(web-site-smartshow-api|smartshow-api)' | awk '{print \$2}' | xargs -r docker kill 2>/dev/null || true && docker ps -a --format '{{.Names}} {{.ID}}' | grep -E '(web-site-smartshow-api|smartshow-api)' | awk '{print \$2}' | xargs -r docker rm -f && sleep 2) || echo 'âœ… Nenhum container problemÃ¡tico encontrado') && echo 'ðŸ”¨ Construindo imagens...' && docker-compose build --no-cache && echo 'ðŸš€ Garantindo que nÃ£o hÃ¡ containers antes de iniciar...' && docker-compose down --remove-orphans 2>/dev/null || true && sleep 2 && echo 'ðŸš€ Iniciando containers (forÃ§ando recriaÃ§Ã£o)...' && docker-compose up -d --force-recreate --remove-orphans && sleep 10 && docker-compose ps && echo 'ðŸŽ‰ Deploy concluÃ­do com sucesso!'"
              else
                echo "âŒ SSM falhou e SSH nÃ£o estÃ¡ disponÃ­vel"
                echo "ðŸ’¡ Configure o secret EC2_SSH_PRIVATE_KEY no GitHub ou habilite SSM na EC2"
                exit 1
              fi
            else
              echo "âœ… Deploy via SSM concluÃ­do com sucesso!"
            fi
          else
            echo "âš ï¸ SSM nÃ£o disponÃ­vel, tentando SSH..."
            
            # Fallback para SSH
            if [ -f ~/.ssh/smartshow.pem ]; then
              ssh -i ~/.ssh/smartshow.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@$EC2_IP "set -e && echo 'ðŸ“¦ Atualizando repositÃ³rio...' && cd /opt/smartshow/smartshow || exit 1 && sudo cp -r web-site/api/data web-site/api/data.backup.\$(date +%Y%m%d_%H%M%S) || true && sudo git fetch origin && sudo git reset --hard origin/main && sudo git pull origin main || true && sudo chown -R ubuntu:ubuntu /opt/smartshow || true && cd web-site && chmod +x cleanup-containers.sh || true && ./cleanup-containers.sh || bash -c 'docker-compose down -v --remove-orphans || true; docker stop smartshow-api web-site-smartshow-api-1 2>/dev/null || true; docker rm -f smartshow-api web-site-smartshow-api-1 2>/dev/null || true; for c in \$(docker ps -aq --filter name=smartshow-api --filter name=web-site-smartshow-api); do docker rm -f \$c || true; done; docker ps -a --format \"{{.Names}} {{.ID}}\" | grep -E \"(smartshow|web-site)\" | awk \"{print \\\$2}\" | xargs -r docker rm -f 2>/dev/null || true; docker container prune -f || true; docker network rm web-site_loja-network loja-network 2>/dev/null || true; docker network prune -f || true; sleep 5' && echo 'ðŸ” Verificando se ainda hÃ¡ containers problemÃ¡ticos...' && (docker ps -a --format '{{.Names}}' | grep -qE '(web-site-smartshow-api|smartshow-api)' && (echo 'âš ï¸ Ainda hÃ¡ containers problemÃ¡ticos, removendo...' && docker ps -a --format '{{.Names}} {{.ID}}' | grep -E '(web-site-smartshow-api|smartshow-api)' | awk '{print \$2}' | xargs -r docker kill 2>/dev/null || true && docker ps -a --format '{{.Names}} {{.ID}}' | grep -E '(web-site-smartshow-api|smartshow-api)' | awk '{print \$2}' | xargs -r docker rm -f && sleep 2) || echo 'âœ… Nenhum container problemÃ¡tico encontrado') && echo 'ðŸ”¨ Construindo imagens...' && docker-compose build --no-cache && echo 'ðŸš€ Garantindo que nÃ£o hÃ¡ containers antes de iniciar...' && docker-compose down --remove-orphans 2>/dev/null || true && sleep 2 && echo 'ðŸš€ Iniciando containers (forÃ§ando recriaÃ§Ã£o)...' && docker-compose up -d --force-recreate --remove-orphans && sleep 10 && docker-compose ps && echo 'ðŸŽ‰ Deploy concluÃ­do com sucesso!'"
            else
              echo "âŒ Nenhum mÃ©todo de acesso disponÃ­vel"
              echo "ðŸ’¡ Configure uma das opÃ§Ãµes:"
              echo "   1. Habilite AWS Systems Manager na EC2 (recomendado)"
              echo "   2. Configure o secret EC2_SSH_PRIVATE_KEY no GitHub"
              exit 1
            fi
          fi

      - name: Verificar deploy
        run: |
          echo "ðŸ” Verificando se a aplicaÃ§Ã£o estÃ¡ respondendo..."
          sleep 5
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ steps.get-ip.outputs.ec2_ip }}:3000/api/health || echo "000")
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "âœ… AplicaÃ§Ã£o estÃ¡ respondendo corretamente!"
            echo "ðŸŒ URL: http://${{ steps.get-ip.outputs.ec2_ip }}:3000"
          else
            echo "âš ï¸ AplicaÃ§Ã£o pode nÃ£o estar respondendo (HTTP $HTTP_CODE)"
            echo "ðŸ’¡ Verifique os logs: ssh -i ~/.ssh/smartshow.pem ubuntu@${{ steps.get-ip.outputs.ec2_ip }} 'cd /opt/smartshow/smartshow/web-site && docker-compose logs'"
          fi

      - name: Resumo do Deploy
        if: always()
        run: |
          echo "## ðŸš€ Deploy ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**IP da EC2:** \`${{ steps.get-ip.outputs.ec2_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL da AplicaÃ§Ã£o:** http://${{ steps.get-ip.outputs.ec2_ip }}:3000" >> $GITHUB_STEP_SUMMARY
          echo "**InstÃ¢ncia:** \`${{ steps.get-ip.outputs.instance_id }}\`" >> $GITHUB_STEP_SUMMARY
